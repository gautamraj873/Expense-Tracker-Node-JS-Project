<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Details</title>
</head>

<body>
  <form id="expenseForm">
    <div>
      <label for="amount">Amount:</label>
      <input type="number" id="amount" name="amount" required>
    </div>
    <div>
      <label for="category">Category:</label>
      <select id="category" name="category" required>
        <option value="">Select a category</option>
        <option value="food">Food</option>
        <option value="transportation">Transportation</option>
        <option value="housing">Housing</option>
      </select>
    </div>
    <div>
      <label for="description">Description:</label>
      <input type="text" id="description" name="description" required>
    </div>
    <div>
      <label for="date">Date:</label>
      <input type="date" id="date" name="date" required>
    </div>
    <button type="submit">Add Expense</button>
  </form>

  <div>
    <button id="rzp-button">Buy Premium</button>
  </div>

  <div id="message"></div>

  <div id="leaderBoard"></div>

  <div id="expenseList">
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Id</th>
          <th scope="col">Amount</th>
          <th scope="col">Category</th>
          <th scope="col">Description</th>
          <th scope="col">Date</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody id="expenseData"></tbody>
    </table>
  </div>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    function retrieveExpenseData() {
      const token = localStorage.getItem('token');
      axios.get('/expense/data', { headers: { "Authorization": token } })
        .then(response => {
          const expenseData = response.data;
          const tableBody = document.getElementById('expenseData');
          let tableHTML = '';

          if (Array.isArray(expenseData)) {
            expenseData.forEach(expense => {
              tableHTML += `
                <tr id="row-id-${expense.id}">
                  <td>${expense.id}</td>
                  <td>${expense.amount}</td>
                  <td>${expense.category}</td>
                  <td>${expense.description}</td>
                  <td>${expense.date}</td>
                  <td>
                    <button type="button" onclick="handleDelete('${expense.id}')">Delete</button>
                  </td>
                </tr>
                `;
            });
          }

          tableBody.innerHTML = tableHTML;
        })
        .catch(error => {
          console.log(error);
        });
    }

    function handleDelete(expenseId) {
      const token = localStorage.getItem('token');
      if (confirm('Are you sure?')) {
        axios.delete(`/expense/delete/${expenseId}`, {
            headers: { "Authorization": token }
          })
          .then(() => {
            const deletedRow = document.getElementById(`row-id-${expenseId}`);
            if (deletedRow) {
              deletedRow.remove();
            }
          })
          .catch(error => {
            console.log(error);
          });
      }
    }

    function handleSubmit(event) {
      event.preventDefault();

      const expenseData = {
        amount: document.getElementById("amount").value,
        category: document.getElementById("category").value,
        description: document.getElementById("description").value,
        date: document.getElementById("date").value
      };

      const token = localStorage.getItem('token');
      axios.post('/expense/data', expenseData, { headers: { "Authorization": token } })
        .then(response => {
          const newExpense = response.data;
          const tableBody = document.getElementById('expenseData');

          const newRow = document.createElement('tr');
          newRow.id = `row-id-${newExpense.id}`;
          newRow.innerHTML = `
            <td>${newExpense.id}</td>
            <td>${newExpense.amount}</td>
            <td>${newExpense.category}</td>
            <td>${newExpense.description}</td>
            <td>${newExpense.date}</td>
            <td>
              <button type="button" onclick="handleDelete('${newExpense.id}')">Delete</button>
            </td>
          `;

          tableBody.appendChild(newRow);

          // Clear input fields
          document.getElementById("description").value = '';
          document.getElementById("amount").value = '';
          document.getElementById("category").value = '';
          document.getElementById("date").value = '';
        })
        .catch(err => {
          console.log(err);
        });
    }

    document.getElementById('rzp-button').onclick = async (event) => {
      event.preventDefault();
      const token = localStorage.getItem('token');
      const purchaseResponse = await axios.get('/purchase/premiumMembership', { headers: { "Authorization": token } });
      const { key_id, order } = purchaseResponse.data;
      var options = {
        "key": key_id,
        "order_id": order.id,
        "handler": async (response) => {
          try {
            const transactionResponse = await axios.post('/purchase/updateTransactionStatus', {
              razorpay_order_id: options.order_id,
              razorpay_payment_id: response.razorpay_payment_id
            }, { headers: { "Authorization": token } });
            if (transactionResponse.data.success) {
              alert('You are a Premium User now');
              localStorage.setItem('token', transactionResponse.data.token);
              showPremiumUser();
            } else {
              alert('Transaction failed');
            }
          } catch (error) {
            alert('Something went wrong');
          }
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
      rzp.on('payment.failed', (response) => {
        alert('Payment Failed');
      });
    }

    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }

    function showPremiumUser() {
      document.getElementById('rzp-button').style.visibility = 'hidden';
      document.getElementById('message').textContent = "You are a Premium User";
      showLeaderBoard();
    }

    function showLeaderBoard() {
        const inputElement = document.createElement('input');
        inputElement.type = 'button';
        inputElement.value = 'Show Leaderboard';
        inputElement.onclick = async () => {
            const token = localStorage.getItem('token');
            axios.get('/premium/showLeaderBoard', { headers: { "Authorization": token } })
            .then(response => {
                const userLeaderBoardArray = response.data;

                const leaderBoardElement = document.getElementById('leaderBoard');
                leaderBoardElement.innerHTML = '<h1>Leader Board</h1>';

                userLeaderBoardArray.forEach(userDetails => {
                const listItem = document.createElement('li');
                listItem.textContent = `Name: ${userDetails.name} Total Expenses: ${userDetails.totalExpenses}`;
                leaderBoardElement.appendChild(listItem);
                });
            })
            .catch(error => {
                console.log(error);
            });
        };
        document.getElementById('message').appendChild(inputElement);
    };


    window.addEventListener('DOMContentLoaded', () => {
        retrieveExpenseData();
        const token = localStorage.getItem('token');

        if (token) {
            const decodeToken = parseJwt(token);
            const isPremiumUser = decodeToken.isPremiumUser;

            if (isPremiumUser) {
            showPremiumUser();
            }
        }
    });


    document.getElementById('expenseForm').addEventListener('submit', handleSubmit);
  </script>
</body>

</html>
